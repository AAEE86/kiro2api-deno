# kiro2api: Go vs Deno å®ç°å¯¹æ¯”

## ğŸ“Š æŠ€æœ¯æ ˆå¯¹æ¯”

| ç»´åº¦ | Go ç‰ˆæœ¬ | Deno ç‰ˆæœ¬ |
|------|---------|-----------|
| **è¯­è¨€** | Go 1.24.0 | TypeScript 5.0+ |
| **è¿è¡Œæ—¶** | åŸç”Ÿç¼–è¯‘ | Deno 2.0+ (V8) |
| **Web æ¡†æ¶** | gin-gonic/gin | åŸç”Ÿ Deno.serve() |
| **JSON å¤„ç†** | bytedance/sonic | åŸç”Ÿ JSON |
| **å¹¶å‘æ¨¡å‹** | Goroutines | Async/Await |
| **ç±»å‹ç³»ç»Ÿ** | é™æ€ç±»å‹ | é™æ€ç±»å‹ (TypeScript) |

## ğŸ¯ æ ¸å¿ƒåŠŸèƒ½å¯¹æ¯”

### 1. Token ç®¡ç†

#### Go ç‰ˆæœ¬
```go
// auth/token_manager.go
type TokenManager struct {
    configs []AuthConfig
    cache   *SimpleTokenCache  // sync.Map
    mu      sync.Mutex
}
```

**ç‰¹ç‚¹**ï¼š
- ä½¿ç”¨ `sync.Map` å®ç°çº¿ç¨‹å®‰å…¨ç¼“å­˜
- `sync.Mutex` æ§åˆ¶å¹¶å‘åˆ·æ–°
- å†…å­˜å ç”¨æä½

#### Deno ç‰ˆæœ¬
```typescript
// auth/token_manager.ts
class TokenCache {
  private cache = new Map<number, CachedToken>();
}
```

**ç‰¹ç‚¹**ï¼š
- ä½¿ç”¨åŸç”Ÿ `Map` å®ç°ç¼“å­˜
- Promise æ§åˆ¶å¹¶å‘åˆ·æ–°
- å•çº¿ç¨‹æ¨¡å‹ï¼Œæ— éœ€é”

**å¯¹æ¯”**ï¼š
- âœ… Deno ä»£ç æ›´ç®€æ´ï¼ˆæ— éœ€æ˜¾å¼é”ï¼‰
- âš ï¸ Go å¹¶å‘æ€§èƒ½æ›´å¥½ï¼ˆçœŸæ­£çš„å¤šçº¿ç¨‹ï¼‰

---

### 2. æµå¼å¤„ç†

#### Go ç‰ˆæœ¬
```go
// server/stream_processor.go
func (sp *StreamProcessor) ProcessStream(req *types.AnthropicRequest) {
    // æ‰‹åŠ¨ç®¡ç† buffer
    buf := make([]byte, 4096)
    // æ‰‹åŠ¨è§£æ EventStream
    parser := parser.NewCompliantEventStreamParser()
}
```

**ç‰¹ç‚¹**ï¼š
- æ‰‹åŠ¨å†…å­˜ç®¡ç†
- é›¶æ‹·è´ä¼˜åŒ–
- ç›´æ¥æ“ä½œå­—èŠ‚æµ

#### Deno ç‰ˆæœ¬
```typescript
// stream_processor.ts
async processStream(req: AnthropicRequest): Promise<ReadableStream<Uint8Array>> {
  return new ReadableStream({
    async start(controller) {
      // ä½¿ç”¨ Web Streams API
    }
  });
}
```

**ç‰¹ç‚¹**ï¼š
- ä½¿ç”¨ Web æ ‡å‡† `ReadableStream`
- è‡ªåŠ¨èƒŒå‹å¤„ç†
- å£°æ˜å¼ API

**å¯¹æ¯”**ï¼š
- âœ… Deno ä»£ç æ›´ç°ä»£åŒ–å’Œæ˜“è¯»
- âœ… Deno ç¬¦åˆ Web æ ‡å‡†
- âš ï¸ Go æ€§èƒ½æ›´é«˜ï¼ˆé›¶æ‹·è´ï¼‰

---

### 3. EventStream è§£æ

#### Go ç‰ˆæœ¬
```go
// parser/compliant_event_stream_parser.go
func (p *CompliantEventStreamParser) Parse(data []byte) {
    // ä½¿ç”¨ binary.BigEndian
    totalLength := binary.BigEndian.Uint32(data[0:4])
}
```

**ç‰¹ç‚¹**ï¼š
- ä½¿ç”¨ `encoding/binary` åŒ…
- é«˜æ€§èƒ½äºŒè¿›åˆ¶è§£æ
- é›¶åˆ†é…ä¼˜åŒ–

#### Deno ç‰ˆæœ¬
```typescript
// parser/event_stream_parser.ts
private readUint32BE(bytes: Uint8Array, offset: number): number {
  return (bytes[offset] << 24) |
         (bytes[offset + 1] << 16) |
         (bytes[offset + 2] << 8) |
         bytes[offset + 3];
}
```

**ç‰¹ç‚¹**ï¼š
- æ‰‹åŠ¨å®ç° BigEndian è¯»å–
- ä½¿ç”¨ `Uint8Array` å’Œ `DataView`
- ä»£ç æ›´æ˜¾å¼

**å¯¹æ¯”**ï¼š
- âœ… Go æœ‰æ ‡å‡†åº“æ”¯æŒï¼Œæ›´ç®€æ´
- âš ï¸ Deno éœ€è¦æ‰‹åŠ¨å®ç°ï¼Œä½†æ›´çµæ´»

---

### 4. HTTP æœåŠ¡å™¨

#### Go ç‰ˆæœ¬
```go
// server/server.go
func StartServer(port string, clientToken string, authService *auth.AuthService) {
    r := gin.Default()
    r.POST("/v1/messages", handleMessages)
    r.Run(":" + port)
}
```

**ç‰¹ç‚¹**ï¼š
- ä½¿ç”¨ Gin æ¡†æ¶
- ä¸­é—´ä»¶ç³»ç»Ÿ
- é«˜æ€§èƒ½è·¯ç”±

#### Deno ç‰ˆæœ¬
```typescript
// server.ts
export async function startServer(config: AppConfig, authService: AuthService) {
  await Deno.serve({
    port: config.port,
    handler: createHandler(config, authService),
  }).finished;
}
```

**ç‰¹ç‚¹**ï¼š
- åŸç”Ÿ `Deno.serve()`
- å‡½æ•°å¼è·¯ç”±
- ç¬¦åˆ Web æ ‡å‡†

**å¯¹æ¯”**ï¼š
- âœ… Deno æ— éœ€å¤–éƒ¨ä¾èµ–
- âœ… Go ç”Ÿæ€æ›´æˆç†Ÿï¼ˆGin åŠŸèƒ½ä¸°å¯Œï¼‰

---

## ğŸ“ˆ æ€§èƒ½å¯¹æ¯”

### åŸºå‡†æµ‹è¯•ç»“æœï¼ˆé¢„ä¼°ï¼‰

| æŒ‡æ ‡ | Go ç‰ˆæœ¬ | Deno ç‰ˆæœ¬ | å·®å¼‚ |
|------|---------|-----------|------|
| **QPS** | ~2000 | ~1400 | -30% |
| **å»¶è¿Ÿ (P50)** | 5ms | 7ms | +40% |
| **å»¶è¿Ÿ (P99)** | 20ms | 30ms | +50% |
| **å†…å­˜å ç”¨** | 20MB | 50MB | +150% |
| **å¯åŠ¨æ—¶é—´** | 8ms | 50ms | +525% |
| **CPU ä½¿ç”¨ç‡** | ä½ | ä¸­ | +30% |

### æ€§èƒ½åˆ†æ

#### Go ä¼˜åŠ¿
1. **ç¼–è¯‘ä¸ºæœºå™¨ç **ï¼šæ— è¿è¡Œæ—¶å¼€é”€
2. **Goroutines**ï¼šçœŸæ­£çš„å¹¶å‘
3. **Sonic JSON**ï¼šæè‡´çš„ JSON æ€§èƒ½
4. **é›¶æ‹·è´ä¼˜åŒ–**ï¼šå†…å­˜æ•ˆç‡é«˜

#### Deno ä¼˜åŠ¿
1. **V8 ä¼˜åŒ–**ï¼šJIT ç¼–è¯‘ä¼˜åŒ–
2. **å¼‚æ­¥ I/O**ï¼šé«˜æ•ˆçš„äº‹ä»¶å¾ªç¯
3. **Web Streams**ï¼šæ ‡å‡†åŒ–çš„æµå¤„ç†
4. **å¼€å‘æ•ˆç‡**ï¼šå¿«é€Ÿè¿­ä»£

---

## ğŸ’» ä»£ç é‡å¯¹æ¯”

| æ¨¡å— | Go ç‰ˆæœ¬ | Deno ç‰ˆæœ¬ | å‡å°‘ |
|------|---------|-----------|------|
| **Token ç®¡ç†** | ~300 è¡Œ | ~200 è¡Œ | -33% |
| **æµå¼å¤„ç†** | ~400 è¡Œ | ~250 è¡Œ | -38% |
| **EventStream è§£æ** | ~500 è¡Œ | ~350 è¡Œ | -30% |
| **HTTP æœåŠ¡å™¨** | ~600 è¡Œ | ~400 è¡Œ | -33% |
| **æ€»è®¡** | ~2500 è¡Œ | ~1600 è¡Œ | -36% |

**ç»“è®º**ï¼šDeno ç‰ˆæœ¬ä»£ç é‡å‡å°‘çº¦ 36%

---

## ğŸ”§ å¼€å‘ä½“éªŒå¯¹æ¯”

### Go ç‰ˆæœ¬

**ä¼˜åŠ¿**ï¼š
- âœ… ç¼–è¯‘æ—¶ç±»å‹æ£€æŸ¥
- âœ… å¼ºå¤§çš„å·¥å…·é“¾ï¼ˆgo fmt, go vetï¼‰
- âœ… æˆç†Ÿçš„ç”Ÿæ€ç³»ç»Ÿ
- âœ… ä¼˜ç§€çš„æ€§èƒ½åˆ†æå·¥å…·

**åŠ£åŠ¿**ï¼š
- âš ï¸ é”™è¯¯å¤„ç†å†—é•¿ï¼ˆ`if err != nil`ï¼‰
- âš ï¸ æ³›å‹æ”¯æŒæœ‰é™
- âš ï¸ åŒ…ç®¡ç†ç›¸å¯¹å¤æ‚

### Deno ç‰ˆæœ¬

**ä¼˜åŠ¿**ï¼š
- âœ… TypeScript åŸç”Ÿæ”¯æŒ
- âœ… ç°ä»£åŒ–çš„ APIï¼ˆWeb æ ‡å‡†ï¼‰
- âœ… å†…ç½®å·¥å…·é“¾ï¼ˆfmt, lint, testï¼‰
- âœ… ç®€æ´çš„ä¾èµ–ç®¡ç†

**åŠ£åŠ¿**ï¼š
- âš ï¸ ç”Ÿæ€ç³»ç»Ÿè¾ƒæ–°
- âš ï¸ æŸäº›åº“ä¸å…¼å®¹
- âš ï¸ è¿è¡Œæ—¶æƒé™ç®¡ç†

---

## ğŸš€ éƒ¨ç½²å¯¹æ¯”

### Go ç‰ˆæœ¬

```bash
# ç¼–è¯‘
go build -ldflags="-s -w" -o kiro2api main.go

# éƒ¨ç½²
scp kiro2api user@server:/opt/
```

**ç‰¹ç‚¹**ï¼š
- å•ä¸€äºŒè¿›åˆ¶æ–‡ä»¶ï¼ˆ~15MBï¼‰
- æ— è¿è¡Œæ—¶ä¾èµ–
- å¯åŠ¨æå¿«

### Deno ç‰ˆæœ¬

```bash
# ç¼–è¯‘
deno compile --allow-net --allow-env --allow-read --unstable-kv \
  --output kiro2api deno-src/main.ts

# éƒ¨ç½²
scp kiro2api user@server:/opt/
```

**ç‰¹ç‚¹**ï¼š
- å•ä¸€å¯æ‰§è¡Œæ–‡ä»¶ï¼ˆ~80MBï¼ŒåŒ…å« V8ï¼‰
- æ— å¤–éƒ¨ä¾èµ–
- å¯åŠ¨è¾ƒæ…¢

---

## ğŸ¯ ä½¿ç”¨åœºæ™¯å»ºè®®

### é€‰æ‹© Go ç‰ˆæœ¬

**é€‚ç”¨åœºæ™¯**ï¼š
- âœ… é«˜æ€§èƒ½è¦æ±‚ï¼ˆQPS > 1000ï¼‰
- âœ… èµ„æºå—é™ç¯å¢ƒ
- âœ… å»¶è¿Ÿæ•æ„Ÿåº”ç”¨
- âœ… ç”Ÿäº§ç¯å¢ƒå¤§è§„æ¨¡éƒ¨ç½²
- âœ… å›¢é˜Ÿç†Ÿæ‚‰ Go

**ç¤ºä¾‹**ï¼š
- ä¼ä¸šçº§ API ç½‘å…³
- é«˜å¹¶å‘ä»£ç†æœåŠ¡
- è¾¹ç¼˜è®¡ç®—èŠ‚ç‚¹

### é€‰æ‹© Deno ç‰ˆæœ¬

**é€‚ç”¨åœºæ™¯**ï¼š
- âœ… å¿«é€ŸåŸå‹å¼€å‘
- âœ… ä¸­å°è§„æ¨¡éƒ¨ç½²ï¼ˆQPS < 500ï¼‰
- âœ… å›¢é˜Ÿç†Ÿæ‚‰ TypeScript
- âœ… è¿½æ±‚ç°ä»£åŒ–å¼€å‘ä½“éªŒ
- âœ… éœ€è¦å¿«é€Ÿè¿­ä»£

**ç¤ºä¾‹**ï¼š
- ä¸ªäººé¡¹ç›®
- åˆåˆ›å…¬å¸ MVP
- å†…éƒ¨å·¥å…·
- å¼€å‘ç¯å¢ƒä»£ç†

---

## ğŸ“Š æ€»ç»“

### Go ç‰ˆæœ¬ï¼šæ€§èƒ½ä¹‹ç‹

**æ ¸å¿ƒä¼˜åŠ¿**ï¼š
- ğŸ† æè‡´æ€§èƒ½
- ğŸ† ä½èµ„æºå ç”¨
- ğŸ† æˆç†Ÿç¨³å®š

**é€‚åˆ**ï¼šè¿½æ±‚æ€§èƒ½å’Œç¨³å®šæ€§çš„ç”Ÿäº§ç¯å¢ƒ

### Deno ç‰ˆæœ¬ï¼šæ•ˆç‡ä¹‹é€‰

**æ ¸å¿ƒä¼˜åŠ¿**ï¼š
- ğŸ† å¼€å‘æ•ˆç‡é«˜
- ğŸ† ä»£ç ç®€æ´
- ğŸ† ç°ä»£åŒ–ä½“éªŒ

**é€‚åˆ**ï¼šå¿«é€Ÿå¼€å‘å’Œä¸­å°è§„æ¨¡éƒ¨ç½²

---

## ğŸ”® æœªæ¥å±•æœ›

### Go ç‰ˆæœ¬
- æŒç»­æ€§èƒ½ä¼˜åŒ–
- æ›´å¤šé«˜çº§ç‰¹æ€§
- ç”Ÿäº§ç¯å¢ƒéªŒè¯

### Deno ç‰ˆæœ¬
- å®Œå–„ OpenAI æ ¼å¼è½¬æ¢
- æ·»åŠ å•å…ƒæµ‹è¯•
- æ€§èƒ½åŸºå‡†æµ‹è¯•
- Docker é•œåƒæ”¯æŒ

---

## ğŸ’¡ æœ€ç»ˆå»ºè®®

**å¦‚æœä½ ä¸ç¡®å®šé€‰å“ªä¸ª**ï¼š

1. **æ€§èƒ½ä¼˜å…ˆ** â†’ Go ç‰ˆæœ¬
2. **å¼€å‘æ•ˆç‡ä¼˜å…ˆ** â†’ Deno ç‰ˆæœ¬
3. **ä¸¤è€…éƒ½è¯•è¯•** â†’ æ ¹æ®å®é™…éœ€æ±‚é€‰æ‹©

**æ··åˆæ–¹æ¡ˆ**ï¼š
- ç”Ÿäº§ç¯å¢ƒç”¨ Go
- å¼€å‘ç¯å¢ƒç”¨ Deno
- æ ¹æ®åœºæ™¯çµæ´»åˆ‡æ¢
